---
title: "Node.js ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚° API ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³"
emoji: "ğŸŒŠ"
type: "tech"
topics: ["nodejs", "stream", "javascript", "backend", "api"]
published: false
publication_name: "correlate_dev"
---

> **æœ¬è¨˜äº‹ã®ã‚³ãƒ¼ãƒ‰ã¯ã™ã¹ã¦ ESMï¼ˆ`"type": "module"` è¨­å®šæ¸ˆã¿ï¼‰ã€Node.js v18+ ã‚’å‰æã¨ã—ã¾ã™ã€‚**
> `node:` ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã¯ Node.js v14.18+ / v16+ ä»¥é™ã§ã®ã¿æœ‰åŠ¹ã§ã™ã€‚ã¾ãŸã€æœ¬è¨˜äº‹ã§ã¯ç¾ä»£çš„ãª `pipeline()` ã‚’ä¸­å¿ƒã«æ‰±ã„ã¾ã™ã€‚`pipe()` ã¨ã®æ¯”è¼ƒã«ã¤ã„ã¦ã¯ã€Œ[`pipeline()` vs `pipe()`](#pipeline-vs-pipe)ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

---

## ã¯ã˜ã‚ã« â”€ ãªãœã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒå¿…è¦ã‹

```mermaid
flowchart TB
    subgraph readFile["ğŸ“ fs.readFileï¼ˆä¸€æ‹¬èª­ã¿è¾¼ã¿ï¼‰"]
        A([é–‹å§‹]) --> B["fs.readFile('large-file.csv')"]
        B --> C["ãƒ•ã‚¡ã‚¤ãƒ«å…¨ä½“ã‚’ãƒ¡ãƒ¢ãƒªã«èª­ã¿è¾¼ã¿\nâš ï¸ 100MB ãŒãã®ã¾ã¾å±•é–‹"]
        C --> D[("ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡\nğŸ”´ ~200MB")]
        D --> E["process(data)\nãƒ‡ãƒ¼ã‚¿å‡¦ç†"]
        E --> F["å‡¦ç†å®Œäº†\nï¼ˆãƒ¡ãƒ¢ãƒªã¯å‡¦ç†ä¸­ãšã£ã¨å æœ‰ï¼‰"]
        F --> G([çµ‚äº†])
    end

    subgraph createReadStream["ğŸŒŠ createReadStreamï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒ å‡¦ç†ï¼‰"]
        H([é–‹å§‹]) --> I["fs.createReadStream('large-file.csv')"]
        I --> J["ãƒãƒ£ãƒ³ã‚¯1ã‚’èª­ã¿è¾¼ã¿\nï¼ˆä¾‹: 64KBï¼‰"]
        J --> K[("ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡\nğŸŸ¢ ~æ•°MB")]
        K --> L["ãƒãƒ£ãƒ³ã‚¯1ã‚’å‡¦ç†"]
        L --> M{"æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ã‚ã‚Š?"}
        M -- "Yesï¼ˆæ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ã‚’èª­ã¿è¾¼ã‚€ï¼‰" --> J
        M -- "No" --> N["å…¨ãƒãƒ£ãƒ³ã‚¯å‡¦ç†å®Œäº†"]
        N --> O([çµ‚äº†])
    end

    subgraph memory["ğŸ“Š ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®æ¯”è¼ƒ"]
        P["ğŸ”´ readFile\nãƒ”ãƒ¼ã‚¯æ™‚: ~200MB\nãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã«æ¯”ä¾‹"]
        Q["ğŸŸ¢ createReadStream\nãƒ”ãƒ¼ã‚¯æ™‚: ~æ•°MB\nãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã«ä¾å­˜ã—ãªã„"]
    end

    readFile ~~~ createReadStream
    createReadStream ~~~ memory
```

Node.js ã§ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’é–‹ç™ºã—ã¦ã„ã‚‹ã¨ã€ã„ã¤ã‹ã¯ã€Œå¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ã—ãŸã‚‰ OOMï¼ˆOut of Memoryï¼‰ãŒç™ºç”Ÿã—ãŸã€ã¨ã„ã†çµŒé¨“ã‚’ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ãã®åŸå› ã®ã»ã¨ã‚“ã©ã¯ã€`fs.readFile` ã«ä»£è¡¨ã•ã‚Œã‚‹ã€Œä¸€æ‹¬èª­ã¿è¾¼ã¿ã€ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«ã‚ã‚Šã¾ã™ã€‚

ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¯ã€ãã†ã—ãŸå•é¡Œã«å¯¾ã™ã‚‹ Node.js ã®æ ¹æœ¬çš„ãªè§£æ±ºç­–ã§ã™ã€‚ã—ã‹ã—ã€ŒçŸ¥ã£ã¦ã„ã‚‹ã€ã¨ã€Œä½¿ã„ã“ãªã›ã‚‹ã€ã®é–“ã«ã¯å¤§ããªã‚®ãƒ£ãƒƒãƒ—ãŒã‚ã‚Šã¾ã™ã€‚æœ¬è¨˜äº‹ã¯ã€ãã®ã‚®ãƒ£ãƒƒãƒ—ã‚’åŸ‹ã‚ã‚‹ãŸã‚ã®å®Ÿè£…ä¸­å¿ƒã®ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã§ã™ã€‚

### å•é¡Œæèµ·ï¼šreadFile vs createReadStream ã®ãƒ¡ãƒ¢ãƒªæ¯”è¼ƒ

100MB ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ã™ã‚‹ 2 ã¤ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’æ¯”è¼ƒã—ã¦ã¿ã¾ã™ã€‚

**`fs.readFile` ã‚’ä½¿ã£ãŸå ´åˆ**

```js
// âŒ ä¸€æ‹¬èª­ã¿è¾¼ã¿ â”€ ãƒ¡ãƒ¢ãƒªã‚’åœ§è¿«ã™ã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
import fs from 'node:fs/promises';

const data = await fs.readFile('large-file.csv'); // 100MB ãŒãã®ã¾ã¾ãƒ¡ãƒ¢ãƒªã«ä¹—ã‚‹
process(data);
```

ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«å…¨ä½“ãŒãƒ¡ãƒ¢ãƒªä¸Šã«å±•é–‹ã•ã‚Œã¾ã™ã€‚RSSï¼ˆResident Set Sizeï¼‰ã®å¤‰åŒ–ã‚’æ¨¡å¼çš„ã«ç¤ºã™ã¨ã€æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```
[readFile ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ]

RSS (MB)
  200 â”‚                    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
  150 â”‚               â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
  100 â”‚          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
   50 â”‚     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
    0 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ æ™‚é–“
         â†‘
         readFile() å‘¼ã³å‡ºã—ã¨åŒæ™‚ã«ãƒ”ãƒ¼ã‚¯ã¸åˆ°é”
         100MB ãƒ•ã‚¡ã‚¤ãƒ«ã«åŠ ãˆã€å‡¦ç†ç”¨ã®ãƒãƒƒãƒ•ã‚¡ã‚‚æ¶ˆè²»
```

**`createReadStream` ã‚’ä½¿ã£ãŸå ´åˆ**

```js
// âœ… ã‚¹ãƒˆãƒªãƒ¼ãƒ å‡¦ç† â”€ ä¸€å®šã®ãƒ¡ãƒ¢ãƒªã§å‡¦ç†ã™ã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
import fs from 'node:fs';
import { pipeline } from 'node:stream/promises';

await pipeline(
  fs.createReadStream('large-file.csv'),
  processStream,       // å¤‰æ›å‡¦ç†ã‚¹ãƒˆãƒªãƒ¼ãƒ 
  outputStream         // å‡ºåŠ›å…ˆã‚¹ãƒˆãƒªãƒ¼ãƒ 
);
```

```
[createReadStream ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ]

RSS (MB)
  200 â”‚
  150 â”‚
  100 â”‚
   50 â”‚  â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ
    0 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ æ™‚é–“
         â†‘
         ãƒãƒ£ãƒ³ã‚¯å˜ä½ã§å‡¦ç†ã€‚RSS ã¯ã»ã¼ä¸€å®š
         highWaterMark ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§å¤‰æ›´å¯èƒ½ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 16 * 1024 bytesï¼‰
         â€» fs.createReadStream ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ 65536 bytesï¼ˆ64KBï¼‰
         â€» objectMode ã®å ´åˆã¯ 16 ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
```

åŒã˜ 100MB ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ã™ã‚‹ã«ã‚‚ã‹ã‹ã‚ã‚‰ãšã€ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã¾ã£ãŸãç•°ãªã‚Šã¾ã™ã€‚ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ä½¿ãˆã°ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã«é–¢ä¿‚ãªãã»ã¼ä¸€å®šã®ãƒ¡ãƒ¢ãƒªã§å‡¦ç†ãŒå®Œäº†ã—ã¾ã™ã€‚

### ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒè§£æ±ºã™ã‚‹ 3 ã¤ã®èª²é¡Œ

#### 1. ãƒ¡ãƒ¢ãƒªåŠ¹ç‡

ä¸Šè¨˜ã®æ¯”è¼ƒãŒç¤ºã™ã¨ãŠã‚Šã€ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¯ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ£ãƒ³ã‚¯ï¼ˆå°ã•ãªæ–­ç‰‡ï¼‰å˜ä½ã§å‡¦ç†ã—ã¾ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒ 1GB ã«ãªã£ã¦ã‚‚ 10GB ã«ãªã£ã¦ã‚‚ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒåŒæ™‚ã«ä¿æŒã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã¯å¸¸ã«ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºåˆ†ã ã‘ã§ã™ã€‚OOM ã®æ ¹æœ¬åŸå› ã‚’æ’é™¤ã§ãã¾ã™ã€‚

#### 2. æ™‚é–“åŠ¹ç‡ï¼ˆTTFB ã®æ”¹å–„ï¼‰

ä¸€æ‹¬å‡¦ç†ã®å ´åˆã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒæƒã†ã¾ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ã‘å–ã‚Œã¾ã›ã‚“ã€‚ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§ã¯ã€æœ€åˆã®ãƒãƒ£ãƒ³ã‚¯ãŒå‡¦ç†ã•ã‚Œæ¬¡ç¬¬ã€å³åº§ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸é€ä¿¡ã§ãã¾ã™ã€‚

```
[ä¸€æ‹¬å‡¦ç†ã® TTFB]
ã‚µãƒ¼ãƒãƒ¼:  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å…¨å‡¦ç†å®Œäº† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ é€ä¿¡é–‹å§‹
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å—ä¿¡é–‹å§‹

[ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã® TTFB]
ã‚µãƒ¼ãƒãƒ¼:  â”€ å‡¦ç†é–‹å§‹ â”€ é€ä¿¡é–‹å§‹ â”€ å‡¦ç†ç¶™ç¶š â”€ å‡¦ç†ç¶™ç¶š ...
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: â”€â”€ å—ä¿¡é–‹å§‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              â†‘ TTFB ãŒåŠ‡çš„ã«çŸ­ç¸®
```

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¯ã‚¨ãƒªçµæœã‚’ HTTP ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã™ã‚‹å ´åˆã€æœ€åˆã®è¡ŒãŒå–å¾—ã§ãæ¬¡ç¬¬ã™ãã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸æµã›ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®å‘ä¸Šã«ç›´çµã—ã¾ã™ã€‚

#### 3. åˆæˆå¯èƒ½æ€§ï¼ˆComposabilityï¼‰

ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¯ Unix ã®ãƒ‘ã‚¤ãƒ—å“²å­¦ã‚’ç¶™æ‰¿ã—ã¦ã„ã¾ã™ã€‚å€‹ã€…ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¯å˜ä¸€ã®è²¬å‹™ã‚’æŒã¡ã€ãã‚Œã‚‰ã‚’ãƒã‚§ãƒ¼ãƒ³çŠ¶ã«æ¥ç¶šã™ã‚‹ã“ã¨ã§è¤‡é›‘ãªå‡¦ç†ã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚

```
[ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®åˆæˆä¾‹]

ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿å–ã‚Š â”€â”€â–¶ gzip åœ§ç¸® â”€â”€â–¶ æš—å·åŒ– â”€â”€â–¶ HTTP ãƒ¬ã‚¹ãƒãƒ³ã‚¹

å„ã‚¹ãƒ†ãƒƒãƒ—ã¯ç‹¬ç«‹ã—ã¦ãƒ†ã‚¹ãƒˆå¯èƒ½
å„ã‚¹ãƒ†ãƒƒãƒ—ã¯å†åˆ©ç”¨å¯èƒ½
å…¨ä½“ã®ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã¯ç¶­æŒã•ã‚Œã‚‹
```

ã“ã®åˆæˆå¯èƒ½æ€§ã“ããŒã€ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ã€Œå˜ãªã‚‹ãƒ¡ãƒ¢ãƒªç¯€ç´„ã®ä»•çµ„ã¿ã€ä»¥ä¸Šã®ä¾¡å€¤ã‚ã‚‹ãƒ„ãƒ¼ãƒ«ã«ã—ã¦ã„ã¾ã™ã€‚

---

## Node.js Stream ã®åŸºç¤ â”€ 4 ç¨®é¡ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ç†è§£ã™ã‚‹

```mermaid
graph TD
    Stream["ğŸŒŠ Node.js ã‚¹ãƒˆãƒªãƒ¼ãƒ "]

    Stream --> Readable["ğŸ“– Readable\nèª­ã¿å–ã‚Šå°‚ç”¨ã‚¹ãƒˆãƒªãƒ¼ãƒ "]
    Stream --> Writable["âœï¸ Writable\næ›¸ãè¾¼ã¿å°‚ç”¨ã‚¹ãƒˆãƒªãƒ¼ãƒ "]
    Stream --> Duplex["ğŸ”„ Duplex\nåŒæ–¹å‘ã‚¹ãƒˆãƒªãƒ¼ãƒ "]
    Stream --> Transform["âš™ï¸ Transform\nå¤‰æ›ã‚¹ãƒˆãƒªãƒ¼ãƒ "]

    Readable --> R1["ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿\nfs.createReadStream"]
    Readable --> R2["HTTP ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡\nIncomingMessage"]
    Readable --> R3["æ¨™æº–å…¥åŠ›\nprocess.stdin"]

    Writable --> W1["ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿\nfs.createWriteStream"]
    Writable --> W2["HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡\nClientRequest"]
    Writable --> W3["æ¨™æº–å‡ºåŠ›\nprocess.stdout"]

    Duplex --> D1["TCP ã‚½ã‚±ãƒƒãƒˆ\nnet.Socket"]
    Duplex --> D2["WebSocket æ¥ç¶š"]
    Duplex --> T_note["Transform ã¯\nDuplex ã‚’ç¶™æ‰¿"]

    Transform --> T1["åœ§ç¸®ãƒ»å±•é–‹\nzlib.createGzip"]
    Transform --> T2["æš—å·åŒ–ãƒ»å¾©å·\ncrypto stream"]
    Transform --> T3["ãƒ‡ãƒ¼ã‚¿å¤‰æ›\nCSV â†’ JSON ãªã©"]

    T_note -.->|ç¶™æ‰¿| Transform

    Readable -->|pipeline æ¥ç¶š| Transform
    Transform -->|pipeline æ¥ç¶š| Writable
    Readable -->|pipeline ç›´çµ| Writable

    style Stream fill:#4a90d9,color:#fff,font-weight:bold
    style Readable fill:#27ae60,color:#fff
    style Writable fill:#e74c3c,color:#fff
    style Duplex fill:#8e44ad,color:#fff
    style Transform fill:#f39c12,color:#fff
    style T_note fill:#ffeaa7,color:#333,stroke:#f39c12
```

Node.js ã® Stream ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ã€4 ç¨®é¡ã®åŸºæœ¬ã‚¯ãƒ©ã‚¹ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚ãã‚Œãã‚Œã®å½¹å‰²ã‚’æ­£ç¢ºã«ç†è§£ã™ã‚‹ã“ã¨ãŒã€é©åˆ‡ãªå®Ÿè£…ã®å‡ºç™ºç‚¹ã«ãªã‚Šã¾ã™ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Node.js Stream ã®åˆ†é¡                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Readable     â”‚  ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿç”£è€…ï¼ˆèª­ã¿å–ã‚Šå¯èƒ½ï¼‰          â”‚
â”‚  Writable     â”‚  ãƒ‡ãƒ¼ã‚¿ã®æ¶ˆè²»è€…ï¼ˆæ›¸ãè¾¼ã¿å¯èƒ½ï¼‰          â”‚
â”‚  Transform    â”‚  ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›è€…ï¼ˆèª­ã¿æ›¸ãä¸¡å¯¾å¿œï¼‰        â”‚
â”‚  Duplex       â”‚  åŒæ–¹å‘é€šä¿¡ï¼ˆèª­ã¿æ›¸ããŒç‹¬ç«‹ï¼‰           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Readable Stream

`Readable` ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¯ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿç”£è€…ã§ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã€HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¯ã‚¨ãƒªçµæœãªã©ã€ã€Œèª­ã¿å–ã‚Œã‚‹ã‚‚ã®ã€ã¯ã™ã¹ã¦ `Readable` ã¨ã—ã¦è¡¨ç¾ã§ãã¾ã™ã€‚

#### paused mode ã¨ flowing mode ã®åˆ‡ã‚Šæ›¿ãˆãƒ¡ã‚«ãƒ‹ã‚ºãƒ 

```mermaid
stateDiagram-v2
    [*] --> Paused : ã‚¹ãƒˆãƒªãƒ¼ãƒ ç”Ÿæˆ

    Paused --> Flowing : .resume() å‘¼ã³å‡ºã—
    Paused --> Flowing : 'data' ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¿½åŠ 
    Paused --> Flowing : .pipe() å‘¼ã³å‡ºã—

    Flowing --> Paused : .pause() å‘¼ã³å‡ºã—
    Flowing --> Paused : .unpipe() å‘¼ã³å‡ºã—

    Flowing --> End : ãƒ‡ãƒ¼ã‚¿èª­ã¿å–ã‚Šå®Œäº†
    Paused --> End : ãƒ‡ãƒ¼ã‚¿èª­ã¿å–ã‚Šå®Œäº†

    End --> [*] : 'end' ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«

    state Paused {
        [*] --> å¾…æ©Ÿä¸­
        å¾…æ©Ÿä¸­ --> èª­ã¿å–ã‚Šå¯èƒ½ : 'readable' ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
        èª­ã¿å–ã‚Šå¯èƒ½ --> å¾…æ©Ÿä¸­ : .read() ã§ãƒ‡ãƒ¼ã‚¿æ¶ˆè²»
    }

    state Flowing {
        [*] --> ãƒ‡ãƒ¼ã‚¿é€å‡ºä¸­
        ãƒ‡ãƒ¼ã‚¿é€å‡ºä¸­ --> ãƒ‡ãƒ¼ã‚¿é€å‡ºä¸­ : 'data' ã‚¤ãƒ™ãƒ³ãƒˆé€£ç¶šç™ºç«
    }
```

`Readable` ã‚¹ãƒˆãƒªãƒ¼ãƒ ã«ã¯ 2 ã¤ã®å‹•ä½œãƒ¢ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã™ã€‚

**paused modeï¼ˆä¸€æ™‚åœæ­¢ãƒ¢ãƒ¼ãƒ‰ï¼‰**

åˆæœŸçŠ¶æ…‹ã®ãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã¯ãƒãƒƒãƒ•ã‚¡ã«è“„ç©ã•ã‚Œã€æ˜ç¤ºçš„ã« `read()` ã‚’å‘¼ã³å‡ºã™ã¾ã§æ¶ˆè²»ã•ã‚Œã¾ã›ã‚“ã€‚

```js
const readable = fs.createReadStream('data.txt');

// paused mode: æ˜ç¤ºçš„ã«èª­ã¿å–ã‚‹
readable.on('readable', () => {
  let chunk;
  while ((chunk = readable.read()) !== null) {
    console.log(`å—ä¿¡: ${chunk.length} bytes`);
  }
});
```

**flowing modeï¼ˆãƒ•ãƒ­ãƒ¼ãƒ¢ãƒ¼ãƒ‰ï¼‰**

`data` ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ç™»éŒ²ã™ã‚‹ã‹ã€`resume()` ã‚’å‘¼ã³å‡ºã™ã¨åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãŒå±Šãæ¬¡ç¬¬ã€è‡ªå‹•çš„ã«ã‚¤ãƒ™ãƒ³ãƒˆã¨ã—ã¦ç™ºç«ã•ã‚Œã¾ã™ã€‚

```js
const readable = fs.createReadStream('data.txt');

// flowing mode: data ã‚¤ãƒ™ãƒ³ãƒˆã§å—ã‘å–ã‚‹
readable.on('data', (chunk) => {
  console.log(`å—ä¿¡: ${chunk.length} bytes`);
});

readable.on('end', () => {
  console.log('èª­ã¿å–ã‚Šå®Œäº†');
});
```

ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆã®é–¢ä¿‚ã‚’æ•´ç†ã™ã‚‹ã¨æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

```
paused mode â”€â”€â–¶ flowing mode
  ãƒ»data ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
  ãƒ»pipe() ã‚’å‘¼ã³å‡ºã™
  ãƒ»resume() ã‚’å‘¼ã³å‡ºã™

flowing mode â”€â”€â–¶ paused mode
  ãƒ»pause() ã‚’å‘¼ã³å‡ºã™
  ãƒ»pipe() ã®æ¥ç¶šå…ˆã‚’ unpipe() ã§è§£é™¤
```

#### data ã‚¤ãƒ™ãƒ³ãƒˆ vs for await...of ã®ä½¿ã„åˆ†ã‘

ç¾ä»£çš„ãª Node.js ã§ã¯ã€`for await...of` ã‚’ä½¿ã£ãŸéåŒæœŸã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ¨å¥¨ã•ã‚Œã¾ã™ã€‚

```js
import fs from 'node:fs';

// âœ… æ¨å¥¨: for await...of ã«ã‚ˆã‚‹éåŒæœŸã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
async function processFile(filePath) {
  const readable = fs.createReadStream(filePath, { encoding: 'utf8' });

  for await (const chunk of readable) {
    // chunk ã”ã¨ã«å‡¦ç†
    await processChunk(chunk);
  }

  console.log('å‡¦ç†å®Œäº†');
}
```

`data` ã‚¤ãƒ™ãƒ³ãƒˆã¨ã®ä½¿ã„åˆ†ã‘ã®åŸºæº–ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

| çŠ¶æ³ | æ¨å¥¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ |
|------|--------------|
| `async/await` ãƒ™ãƒ¼ã‚¹ã®æ–°è¦ã‚³ãƒ¼ãƒ‰ | `for await...of` |
| ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã®æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¨ã®çµ±åˆ | `data` ã‚¤ãƒ™ãƒ³ãƒˆ |
| ç´°ã‹ã„ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡ãŒå¿…è¦ãªå ´åˆ | `readable` ã‚¤ãƒ™ãƒ³ãƒˆ + `read()` |
| `pipeline()` ã§æ¥ç¶šã™ã‚‹å ´åˆ | ã©ã¡ã‚‰ã§ã‚‚ä¸è¦ï¼ˆè‡ªå‹•å‡¦ç†ï¼‰|

#### ã‚«ã‚¹ã‚¿ãƒ  Readable ã®å®Ÿè£…ï¼ˆ_read ãƒ•ãƒƒã‚¯ï¼‰

```mermaid
sequenceDiagram
    participant C as Consumer
    participant RS as ReadableStream
    participant R as _read()
    participant BP as ãƒãƒƒã‚¯ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼åˆ¶å¾¡

    C->>RS: read() / pipe() ã§ãƒ‡ãƒ¼ã‚¿è¦æ±‚
    RS->>RS: ãƒãƒƒãƒ•ã‚¡ç¢ºèªï¼ˆhighWaterMark ãƒã‚§ãƒƒã‚¯ï¼‰
    alt ãƒãƒƒãƒ•ã‚¡ãŒç©ºã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿ä¸è¶³
        RS->>R: _read(size) å‘¼ã³å‡ºã—
        R->>R: ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—
        R->>RS: push(chunk) ã§ãƒ‡ãƒ¼ã‚¿ä¾›çµ¦
        RS->>RS: å†…éƒ¨ãƒãƒƒãƒ•ã‚¡ã«ãƒãƒ£ãƒ³ã‚¯ã‚’è¿½åŠ 
        alt push() ã®æˆ»ã‚Šå€¤ãŒ false
            RS->>BP: ãƒãƒƒã‚¯ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ç™ºç”Ÿï¼ˆãƒãƒƒãƒ•ã‚¡è¶…éï¼‰
            BP->>R: ãƒ‡ãƒ¼ã‚¿ç”Ÿç”£ã‚’ä¸€æ™‚åœæ­¢
            Note over BP,R: highWaterMark ã‚’è¶…ãˆãŸãŸã‚åœæ­¢
        else push() ã®æˆ»ã‚Šå€¤ãŒ true
            RS->>C: data ã‚¤ãƒ™ãƒ³ãƒˆ / read() ã§ãƒãƒ£ãƒ³ã‚¯è¿”å´
        end
    else ãƒãƒƒãƒ•ã‚¡ã«ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š
        RS->>C: ãƒãƒƒãƒ•ã‚¡ã‹ã‚‰ãƒãƒ£ãƒ³ã‚¯ã‚’è¿”å´
    end

    C->>RS: ãƒ‡ãƒ¼ã‚¿æ¶ˆè²»ï¼ˆread / drainï¼‰
    RS->>BP: ãƒãƒƒãƒ•ã‚¡ã«ä½™è£•ãŒç”Ÿã˜ãŸ
    BP->>R: resume() / _read() å†å‘¼ã³å‡ºã—
    R->>RS: push(chunk) å†é–‹
    RS->>C: data ã‚¤ãƒ™ãƒ³ãƒˆå†é–‹

    alt ã‚¹ãƒˆãƒªãƒ¼ãƒ çµ‚ç«¯
        R->>RS: push(null) ã§çµ‚ç«¯é€šçŸ¥
        RS->>C: end ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œ
    end
```

ç‹¬è‡ªã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‹ã‚‰ `Readable` ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ä½œã‚‹å ´åˆã€`_read()` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã¾ã™ã€‚

```js
import { Readable } from 'node:stream';

class CounterReadable extends Readable {
  constructor(limit) {
    super({ objectMode: true }); // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãã®ã¾ã¾æµã™å ´åˆã¯ objectMode: true
    this.count = 0;
    this.limit = limit;
  }

  _read() {
    if (this.count < this.limit) {
      // push() ã§ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒãƒ•ã‚¡ã«è¿½åŠ 
      // åŒæœŸãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã®å ´åˆã€push() ãŒ false ã‚’è¿”ã—ã¦ã‚‚
      // Node.js å†…éƒ¨ãŒ _read() ã®å†å‘¼ã³å‡ºã—ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã€
      // è¿½åŠ ã®åˆ¶å¾¡ã¯ä¸è¦ã€‚
      // éåŒæœŸãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã®å ´åˆã¯ DatabaseCursorReadable ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å‚ç…§ã€‚
      this.push(this.count++);
    } else {
      // null ã‚’ push() ã™ã‚‹ã“ã¨ã§ EOFï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒ çµ‚ç«¯ï¼‰ã‚’é€šçŸ¥
      this.push(null);
    }
  }
}

// ä½¿ç”¨ä¾‹
const counter = new CounterReadable(10);

for await (const num of counter) {
  console.log(num); // 0, 1, 2, ..., 9
}
```

`_read()` ã¯ Consumer ãŒãƒ‡ãƒ¼ã‚¿ã‚’è¦æ±‚ã—ãŸã¨ãã«å‘¼ã°ã‚Œã¾ã™ã€‚`push()` ã®æˆ»ã‚Šå€¤ï¼ˆ`false` ã®å ´åˆã¯ãƒãƒƒã‚¯ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ç™ºç”Ÿï¼‰ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã§ã€éåŒæœŸãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã§ã®ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡ãŒå¯èƒ½ã§ã™ï¼ˆè©³ç´°ã¯ã€Œ[ãƒãƒƒã‚¯ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼](#ãƒãƒƒã‚¯ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼)ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§ï¼‰ã€‚

éåŒæœŸãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‹ã‚‰ã®å®Ÿè£…ä¾‹ã‚‚ç¤ºã—ã¾ã™ã€‚

```js
import { Readable } from 'node:stream';

class DatabaseCursorReadable extends Readable {
  constructor(cursor) {
    super({ objectMode: true });
    this.cursor = cursor;
    this.reading = false;
  }

  // æ³¨æ„: _read() ã‚’ async ã«ã™ã‚‹ã¨ Node.js å†…éƒ¨ãŒ Promise ã® rejection ã‚’
  // æ•æ‰ã§ããšã€æœªå‡¦ç†ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹ï¼ˆç‰¹ã« Node.js v18 ä»¥å‰ï¼‰ã€‚
  // ãã®ãŸã‚ã€Promise ãƒã‚§ãƒ¼ãƒ³ã§è¨˜è¿°ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã™ã‚‹ã€‚
  _read() {
    if (this.reading) return;
    this.reading = true;

    this.cursor.fetchOne()
      .then((row) => {
        this.reading = false;
        if (row === null) {
          this.push(null); // ãƒ‡ãƒ¼ã‚¿ãªã— â†’ EOF
        } else {
          // push() ãŒ false ã‚’è¿”ã—ãŸå ´åˆã€Consumer ã®æº–å‚™ãŒã§ããŸã¨ãã«
          // Node.js å†…éƒ¨ã‹ã‚‰ _read() ãŒå†åº¦å‘¼ã°ã‚Œã‚‹
          this.push(row);
        }
      })
      .catch((err) => this.destroy(err)); // ã‚¨ãƒ©ãƒ¼ã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒ ã«ä¼æ’­
  }
}
```

### Writable Stream

`Writable` ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¯ãƒ‡ãƒ¼ã‚¿ã®æ¶ˆè²»è€…ã§ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®æ›¸ãè¾¼ã¿ã€HTTP ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æŒ¿å…¥ãªã©ã€ã€Œæ›¸ãè¾¼ã‚ã‚‹å ´æ‰€ã€ã¯ã™ã¹ã¦ `Writable` ã¨ã—ã¦è¡¨ç¾ã§ãã¾ã™ã€‚

#### _write() vs _writev() ã®é¸æŠåŸºæº–

ã‚«ã‚¹ã‚¿ãƒ  `Writable` ã‚’å®Ÿè£…ã™ã‚‹éš›ã€2 ã¤ã®æ›¸ãè¾¼ã¿ãƒ•ãƒƒã‚¯ã‚’é¸æŠã§ãã¾ã™ã€‚

```js
import { Writable } from 'node:stream';

// _write(): 1 ãƒãƒ£ãƒ³ã‚¯ãšã¤å‡¦ç†ã™ã‚‹åŸºæœ¬å®Ÿè£…
class LogWritable extends Writable {
  constructor(options) {
    super(options);
    this.logBuffer = [];
  }

  _write(chunk, encoding, callback) {
    // chunk: æ›¸ãè¾¼ã¾ã‚ŒãŸãƒ‡ãƒ¼ã‚¿
    // encoding: æ–‡å­—åˆ—ã®å ´åˆã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
    // callback: å‡¦ç†å®Œäº†ã‚’é€šçŸ¥ã™ã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°å¼•æ•°ã«æ¸¡ã™ï¼‰

    this.logBuffer.push(chunk.toString());

    // éåŒæœŸå‡¦ç†ãŒå®Œäº†ã—ãŸã‚‰ callback ã‚’å‘¼ã¶
    callback();
  }
}
```
